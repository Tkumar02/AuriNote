<div class="container-fluid py-5 bg-light min-vh-100">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
            
            <div class="text-center mb-5">
                <h1 class="font-weight-bold display-4 mb-2" style="color: #6a1b9a; font-size: 2.5rem;">
                    Invoice Summary
                </h1>
                
                <div *ngIf="invoices && invoices.length > 0" class="d-flex justify-content-center mb-4">
                    <div class="mx-3 text-center">
                        <small class="text-muted font-weight-bold text-uppercase">Invoice Total</small>
                        <h3 class="font-weight-bold mb-0">¬£{{ totalSum | number:'1.2-2' }}</h3>
                    </div>
                    <div class="mx-3 text-center border-left pl-3">
                        <small class="text-muted font-weight-bold text-uppercase">Invoices</small>
                        <h3 class="font-weight-bold mb-0">{{ invoiceTotal }}</h3>
                    </div>
                </div>

                <div class="d-flex justify-content-center">
                    <button class="btn btn-info px-4 shadow-sm mr-2" (click)="viewInvoices()">View All</button>
                    <button class="btn btn-outline-info px-4 shadow-sm" (click)="viewSelectedInvoices()">Filter Dates</button>
                </div>
            </div>

            <div *ngIf="showDatebox && !showBox" class="card border-0 shadow-sm mb-4">
                <div class="card-body bg-white rounded">
                    <div *ngIf="message" class="alert alert-info py-2 small font-weight-bold">{{message}}</div>
                    <div class="form-row align-items-end">
                        <div class="form-group col-md-3">
                            <label class="small font-weight-bold">Business</label>
                            <select class="form-control" [(ngModel)]="selectedBusiness">
                                <option *ngFor="let business of businessOptions" [value]="business">{{ business }}</option>
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label class="small font-weight-bold">Start Date</label>
                            <input type="date" class="form-control" [(ngModel)]="startDate">
                        </div>
                        <div class="form-group col-md-3">
                            <label class="small font-weight-bold">End Date</label>
                            <input type="date" class="form-control" [(ngModel)]="endDate">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success btn-block" (click)="retrieveInvoices(startDate,endDate)">Apply Filters</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="table-responsive">
                    <table *ngIf="invoices && invoices.length > 0" class="table table-hover mb-0">
                        <thead class="thead-light text-uppercase small font-weight-bold">
                            <tr>
                                <th>Date</th>
                                <th>Client & ID</th>
                                <th>Invoice Total</th>
                                <th>Status</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
<tbody>
    <tr *ngFor="let invoice of invoices; let i=index" 
        [ngClass]="{'row-paid': invoice.paid, 'row-pending': !invoice.paid}">
        
        <td class="align-middle small font-weight-bold">{{invoice.date | date}}</td>
        
        <td class="align-middle">
            <span class="d-block font-weight-bold text-dark">{{invoice.clientName}}</span>
            <small class="text-muted">{{invoice.invoiceID}}</small>
        </td>
        
        <td class="align-middle font-weight-bold text-dark">
            ¬£{{invoice.total | number:'1.2-2'}}
        </td>
        
        <td class="align-middle">
            <span class="badge badge-pill px-3 py-2 shadow-sm border" 
                  [ngClass]="invoice.paid ? 'badge-success' : 'badge-warning'">
                {{invoice.paid ? 'PAID: ¬£' + (invoice.final | number:'1.2-2') : 'PENDING'}}
            </span>
        </td>
        
        <td class="align-middle text-right">
            <div class="btn-group shadow-sm bg-white rounded">
                <button class="btn btn-sm btn-white border-0" (click)="setSelectedInvoice(i)" data-toggle="modal" data-target="#paymentModal" title="Payment">üí∞</button>
                <button class="btn btn-sm btn-white border-0" (click)="setSelectedInvoice(i)" data-toggle="modal" data-target="#notesModal" title="Notes">üìù</button>
                <button class="btn btn-sm btn-white border-0" (click)="generatePDF(i)" data-toggle="modal" data-target="#pdfModal" title="PDF">üìÑ</button>
                <button class="btn btn-sm btn-white border-0 text-danger" (click)="setSelectedInvoice(i)" data-toggle="modal" data-target="#deleteModal" title="Delete">üóëÔ∏è</button>
            </div>
        </td>
    </tr>
</tbody>
                    </table>
                    <div *ngIf="showBox && !dateBox" class="p-5 text-center text-muted">
                        <i class="fa fa-folder-open-o mb-2 display-4 d-block opacity-25"></i>
                        No invoices found for the selected range.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title font-weight-bold">Edit Payment: {{selectedInvoice?.invoiceID}}</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="mb-4">Choose a payment action for this invoice.</p>
                <div *ngIf="editInput" class="form-group bg-light p-3 rounded shadow-sm">
                    <label class="small font-weight-bold d-block mb-2">Enter new payment amount:</label>
                    <div class="input-group">
                        <div class="input-group-prepend"><span class="input-group-text">¬£</span></div>
                        <input [(ngModel)]="newPayment" type="number" class="form-control form-control-lg" name="newPayment">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <ng-container *ngIf="!editInput">
                    <button type="button" class="btn btn-success px-4" data-dismiss="modal" (click)="confirmFull(selectedInvoice)">Confirm Full Payment</button>
                    <button type="button" class="btn btn-warning px-4" (click)="changePayment()">Edit Amount</button>
                </ng-container>
                <ng-container *ngIf="editInput">
                    <button type="button" class="btn btn-success btn-lg btn-block mx-3" (click)="editPayment(selectedInvoice.id)" data-dismiss="modal">Confirm New Payment</button>
                </ng-container>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notesModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header text-white" style="background-color: #6a1b9a;">
                <h5 class="modal-title font-weight-bold">Notes - {{selectedInvoice?.invoiceID}}</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-4">
                <div *ngIf="!showNotes" class="p-3 bg-light rounded border" style="min-height: 100px; white-space: pre-wrap;">
                    {{selectedInvoice && selectedInvoice.notes ? selectedInvoice.notes : 'There are no notes attached to this invoice'}}
                </div>
                <textarea *ngIf="showNotes" [(ngModel)]="selectedInvoice.notes" class="form-control" rows="5"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="showNotes=false">Close</button>
                <button *ngIf="!showNotes" type="button" class="btn btn-warning" (click)="showNotes=!showNotes">Edit Notes</button>
                <button *ngIf="showNotes" class="btn btn-success" (click)="submitNotes(selectedInvoice.id,selectedInvoice.notes)" data-dismiss="modal">Submit Notes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title font-weight-bold">Confirm Deletion</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="h5 mb-3 text-danger">Are you sure?</p>
                <p>This will permanently remove <strong>{{selectedInvoice?.invoiceID}}</strong>.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button class="btn btn-light px-4 border" data-dismiss="modal">Cancel</button>
                <button (click)="deleteInvoice(selectedInvoice.id)" class="btn btn-danger px-4" data-dismiss="modal">Confirm Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="pdfModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title font-weight-bold">View Invoice Preview</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0 bg-secondary">
                <div class="preview-container p-3">
                    <app-invoice-preview *ngIf="childPDF" [message]="selectedInvoice"></app-invoice-preview>
                </div>
            </div>
            <div class="modal-footer bg-white border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>